require 'rails_helper'

RSpec.describe EnrichPrayerIntentionJob, type: :job do
  let(:user) { create(:user) }
  let(:prayer_intention) { create(:prayer_intention, user: user, title: 'Healing', description: 'For my mother') }
  let(:perplexity_service) { instance_double(PerplexityApiService) }
  let(:generated_prayer) do\n    <<~PRAYER\n      Almighty God, the giver of life and health,\n      in whom is the source of all healing power:\n      Look with mercy upon your servant who is afflicted with illness,\n      grant them patience in their suffering,\n      and restore them to health of body and spirit;\n      through Jesus Christ our Lord. Amen.\n    PRAYER\n  end\n  \n  before do\n    allow(PerplexityApiService).to receive(:new).and_return(perplexity_service)\n    allow(perplexity_service).to receive(:generate_prayer).and_return(generated_prayer)\n  end\n  \n  describe '#perform' do\n    it 'generates Anglican prayer for intention' do\n      described_class.perform_now(prayer_intention.id)\n      \n      prayer_intention.reload\n      expect(prayer_intention.generated_prayer).to be_present\n      expect(prayer_intention.generated_prayer).to include('Almighty God')\n      expect(prayer_intention.generated_prayer).to include('Amen')\n    end\n    \n    it 'marks prayer intention as AI enriched' do\n      described_class.perform_now(prayer_intention.id)\n      \n      prayer_intention.reload\n      expect(prayer_intention.ai_enriched_at).to be_present\n      expect(prayer_intention.ai_model_version).to eq(PerplexityApiService::DEFAULT_MODEL)\n    end\n    \n    it 'logs the generation process' do\n      expect(Rails.logger).to receive(:info).with(/Starting prayer generation for PrayerIntention/)\n      expect(Rails.logger).to receive(:info).with(/Successfully generated prayer/)\n      \n      described_class.perform_now(prayer_intention.id)\n    end\n    \n    it 'skips generation if already has prayer and up to date' do\n      prayer_intention.mark_as_ai_enriched!\n      \n      expect(perplexity_service).not_to receive(:generate_prayer)\n      expect(Rails.logger).to receive(:info).with(/already has prayer, skipping/)\n      \n      described_class.perform_now(prayer_intention.id)\n    end\n    \n    it 'calls Perplexity API service' do\n      expect(perplexity_service).to receive(:generate_prayer).with(prayer_intention)\n      \n      described_class.perform_now(prayer_intention.id)\n    end\n  end\n  \n  describe 'error handling' do\n    it 'logs error when prayer intention not found' do\n      expect(Rails.logger).to receive(:error).with(/not found/)\n      \n      expect {\n        described_class.perform_now(999999)\n      }.not_to raise_error\n    end\n    \n    it 'raises error on API failure for retry' do\n      allow(perplexity_service).to receive(:generate_prayer)\n        .and_raise(PerplexityApiService::PerplexityError, 'API Error')\n      \n      expect(Rails.logger).to receive(:error).with(/Failed to generate prayer/)\n      \n      expect {\n        described_class.perform_now(prayer_intention.id)\n      }.to raise_error(PerplexityApiService::PerplexityError)\n    end\n    \n    it 'handles rate limit errors' do\n      allow(perplexity_service).to receive(:generate_prayer)\n        .and_raise(PerplexityApiService::RateLimitError, 'Rate limited')\n      \n      expect {\n        described_class.perform_now(prayer_intention.id)\n      }.to raise_error(PerplexityApiService::RateLimitError)\n    end\n  end\n  \n  describe 'retry behavior' do\n    it 'retries on PerplexityError' do\n      expect(described_class.retry_on_block_for(PerplexityApiService::PerplexityError)).to be_present\n    end\n    \n    it 'retries on RateLimitError' do\n      expect(described_class.retry_on_block_for(PerplexityApiService::RateLimitError)).to be_present\n    end\n    \n    it 'discards on AuthenticationError' do\n      expect(described_class.discard_on_block_for(PerplexityApiService::AuthenticationError)).to be_present\n    end\n  end\n  \n  describe 'user notification' do\n    let(:notification_service) { class_double(NotificationService) }\n    \n    before do\n      allow(NotificationService).to receive(:send_notification)\n    end\n    \n    context 'when user has FCM tokens' do\n      before do\n        create(:fcm_token, user: user, token: 'test-token')\n      end\n      \n      it 'sends notification to user' do\n        expect(NotificationService).to receive(:send_notification).with(\n          user: user,\n          title: 'Prayer Generated',\n          body: include(prayer_intention.title),\n          data: hash_including(\n            type: 'prayer_intention_generated',\n            prayer_intention_id: prayer_intention.id\n          )\n        )\n        \n        described_class.perform_now(prayer_intention.id)\n      end\n      \n      it 'does not fail job if notification fails' do\n        allow(NotificationService).to receive(:send_notification)\n          .and_raise(StandardError, 'Notification error')\n        \n        expect(Rails.logger).to receive(:warn).with(/Failed to send prayer generation notification/)\n        \n        expect {\n          described_class.perform_now(prayer_intention.id)\n        }.not_to raise_error\n      end\n    end\n    \n    context 'when user has no FCM tokens' do\n      it 'does not send notification' do\n        expect(NotificationService).not_to receive(:send_notification)\n        \n        described_class.perform_now(prayer_intention.id)\n      end\n    end\n  end\n  \n  describe 'job configuration' do\n    it 'queues on default queue' do\n      expect(described_class.new.queue_name).to eq('default')\n    end\n    \n    it 'has timeout configured' do\n      expect(described_class.timeout).to eq(2.minutes)\n    end\n  end\n  \n  describe 'integration test' do\n    it 'performs full prayer generation flow', :vcr do\n      described_class.perform_now(prayer_intention.id)\n      \n      prayer_intention.reload\n      \n      # Verify prayer is generated\n      expect(prayer_intention.ai_enriched?).to be true\n      expect(prayer_intention.generated_prayer).to be_present\n      \n      # Verify metadata\n      expect(prayer_intention.ai_enriched_at).to be_within(1.second).of(Time.current)\n      expect(prayer_intention.ai_model_version).to be_present\n    end\n  end\nend\n