require 'rails_helper'

RSpec.describe PrayerIntention, type: :model do
  let(:user) { create(:user) }
  
  describe 'associations' do
    it { should belong_to(:user) }
  end
  
  describe 'validations' do
    subject { build(:prayer_intention, user: user) }
    
    it { should validate_presence_of(:title) }
    it { should validate_length_of(:title).is_at_least(3).is_at_most(200) }
    it { should validate_length_of(:description).is_at_most(5000) }
    it { should validate_length_of(:answer_notes).is_at_most(2000) }
    it { should validate_presence_of(:status) }
    
    it 'validates category inclusion' do
      valid_categories = %w[personal family community world thanksgiving intercession]
      valid_categories.each do |category|
        intention = build(:prayer_intention, user: user, category: category)
        expect(intention).to be_valid\n      end\n      \n      invalid_intention = build(:prayer_intention, user: user, category: 'invalid')
      expect(invalid_intention).not_to be_valid
      expect(invalid_intention.errors[:category]).to include('is not included in the list')
    end\n    \n    it 'allows blank category' do\n      intention = build(:prayer_intention, user: user, category: nil)\n      expect(intention).to be_valid\n    end\n  end\n  \n  describe 'enums' do\n    it { should define_enum_for(:status).with_values(pending: 0, praying: 1, answered: 2, archived: 3).with_prefix(:status) }\n    \n    it 'defaults to pending status' do\n      intention = PrayerIntention.new(user: user, title: 'Test')\n      expect(intention.status).to eq('pending')\n    end\n  end\n  \n  describe 'scopes' do\n    let!(:pending_intention) { create(:prayer_intention, user: user, status: :pending) }\n    let!(:praying_intention) { create(:prayer_intention, user: user, status: :praying) }\n    let!(:answered_intention) { create(:prayer_intention, user: user, status: :answered) }\n    let!(:archived_intention) { create(:prayer_intention, user: user, status: :archived) }\n    let!(:with_prayer_intention) { create(:prayer_intention, user: user, :with_prayer) }\n    \n    describe '.active' do\n      it 'returns pending and praying intentions' do\n        expect(PrayerIntention.active).to contain_exactly(pending_intention, praying_intention)\n      end\n    end\n    \n    describe '.answered' do\n      it 'returns only answered intentions' do\n        expect(PrayerIntention.answered).to contain_exactly(answered_intention)\n      end\n    end\n    \n    describe '.archived' do\n      it 'returns only archived intentions' do\n        expect(PrayerIntention.archived).to contain_exactly(archived_intention)\n      end\n    end\n    \n    describe '.ai_enriched' do\n      it 'returns intentions with generated prayers' do\n        expect(PrayerIntention.ai_enriched).to contain_exactly(with_prayer_intention)\n      end\n    end\n    \n    describe '.needs_enrichment' do\n      it 'returns intentions without generated prayers' do\n        expect(PrayerIntention.needs_enrichment).not_to include(with_prayer_intention)\n      end\n    end\n  end\n  \n  describe 'callbacks' do\n    describe 'strip_whitespace' do\n      it 'strips whitespace from title' do\n        intention = create(:prayer_intention, user: user, title: '  Test Title  ')\n        expect(intention.title).to eq('Test Title')\n      end\n      \n      it 'strips whitespace from description' do\n        intention = create(:prayer_intention, user: user, description: '  Test Description  ')\n        expect(intention.description).to eq('Test Description')\n      end\n    end\n    \n    describe 'set_defaults' do\n      it 'sets default values on new record' do\n        intention = PrayerIntention.new(user: user, title: 'Test')\n        expect(intention.status).to eq('pending')\n        expect(intention.prayer_count).to eq(0)\n      end\n    end\n  end\n  \n  describe '#mark_as_answered!' do\n    let(:intention) { create(:prayer_intention, user: user, status: :praying) }\n    \n    it 'updates status to answered' do\n      intention.mark_as_answered!(notes: 'Prayer answered!')\n      expect(intention.reload.status).to eq('answered')\n    end\n    \n    it 'sets answered_at timestamp' do\n      intention.mark_as_answered!\n      expect(intention.reload.answered_at).to be_present\n    end\n    \n    it 'saves answer notes' do\n      intention.mark_as_answered!(notes: 'God is good!')\n      expect(intention.reload.answer_notes).to eq('God is good!')\n    end\n  end\n  \n  describe '#archive!' do\n    let(:intention) { create(:prayer_intention, user: user, status: :answered) }\n    \n    it 'updates status to archived' do\n      intention.archive!\n      expect(intention.reload.status).to eq('archived')\n    end\n  end\n  \n  describe '#record_prayer!' do\n    let(:intention) { create(:prayer_intention, user: user, prayer_count: 5) }\n    \n    it 'increments prayer count' do\n      expect { intention.record_prayer! }.to change { intention.reload.prayer_count }.from(5).to(6)\n    end\n    \n    it 'updates last_prayed_at timestamp' do\n      intention.record_prayer!\n      expect(intention.reload.last_prayed_at).to be_present\n    end\n  end\n  \n  describe '#needs_ai_enrichment?' do\n    it 'returns true when prayer not generated' do\n      intention = create(:prayer_intention, user: user, ai_enriched_at: nil)\n      expect(intention.needs_ai_enrichment?).to be true\n    end\n    \n    it 'returns false when prayer already generated' do\n      intention = create(:prayer_intention, user: user, ai_enriched_at: 1.minute.ago)\n      expect(intention.needs_ai_enrichment?).to be false\n    end\n  end\n  \n  describe '#ai_enriched?' do\n    it 'returns true when prayer generated' do\n      intention = create(:prayer_intention, user: user, ai_enriched_at: Time.current)\n      expect(intention.ai_enriched?).to be true\n    end\n    \n    it 'returns false when prayer not generated' do\n      intention = create(:prayer_intention, user: user, ai_enriched_at: nil)\n      expect(intention.ai_enriched?).to be false\n    end\n  end\n  \n  describe '#mark_as_ai_enriched!' do\n    let(:intention) { create(:prayer_intention, user: user) }\n    \n    it 'sets ai_enriched_at timestamp' do\n      intention.mark_as_ai_enriched!\n      expect(intention.reload.ai_enriched_at).to be_present\n    end\n    \n    it 'sets ai_model_version' do\n      intention.mark_as_ai_enriched!(model_version: 'perplexity-2.0')\n      expect(intention.reload.ai_model_version).to eq('perplexity-2.0')\n    end\n    \n    it 'uses default model version when not provided' do\n      intention.mark_as_ai_enriched!\n      expect(intention.reload.ai_model_version).to eq('perplexity-1.0')\n    end\n  end\n  \n  describe '#full_text' do\n    it 'combines title and description' do\n      intention = create(:prayer_intention, user: user, title: 'Healing', description: 'For my mother')\n      expect(intention.full_text).to eq(\"Healing\\n\\nFor my mother\")\n    end\n    \n    it 'handles nil description' do\n      intention = create(:prayer_intention, user: user, title: 'Healing', description: nil)\n      expect(intention.full_text).to eq('Healing')\n    end\n  end\n  \n  describe '#prayer_stats' do\n    let(:intention) do\n      create(:prayer_intention,\n             user: user,\n             prayer_count: 10,\n             last_prayed_at: 1.day.ago,\n             created_at: 5.days.ago)\n    end\n    \n    it 'returns prayer statistics' do\n      stats = intention.prayer_stats\n      expect(stats[:total_prayers]).to eq(10)\n      expect(stats[:last_prayed]).to be_present\n      expect(stats[:days_since_created]).to be >= 5\n    end\n  end\n  \n  describe '#as_json_api' do\n    let(:intention) do\n      create(:prayer_intention,\n             user: user,\n             title: 'Test Prayer',\n             :with_prayer)\n    end\n    \n    it 'returns properly formatted JSON' do\n      json = intention.as_json_api\n      expect(json[:id]).to eq(intention.id)\n      expect(json[:title]).to eq('Test Prayer')\n      expect(json[:generated_prayer]).to be_present\n      expect(json[:stats]).to be_a(Hash)\n    end\n  end\n  \n  describe '.categories' do\n    it 'returns list of valid categories' do\n      expect(PrayerIntention.categories).to eq(%w[personal family community world thanksgiving intercession])\n    end\n  end\nend\n